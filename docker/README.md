# Running the local instance

## Prerequisites

Install docker compose.

Create a webpack bundle in `../static/client/js/main.js`.
This will be the initial javascript file served to the client.
If building the production image, it will be the javascript file served to the user.

## Running the production server

In the 'docker' directory, run:

```
docker compose build
docker compose up webserver
```

Access the page at `localhost:8080` in your browser.

When you are done, use:

```
docker compose down
```

## Running the development server

The development server is supposed to make the `edit -> update -> edit` feedback loop quicker.
Basically, it listens for file updates in `server/` or `client/` and reloads relevant files when this happens.

The development server assumes that you have installed webpack in the client nodejs package (this should be in the package.json).

In the 'docker' directory, run:

```
docker compose build
docker compose up webserver-local
```

When you are done, use:

```
docker compose down
```

## Debugging

The `shell.sh` script will launch a shell in a running webserver.
From there, you can run run migrations, use the Django shell and otherwise debug the local setup.

```
./scripts/shell.sh
```

## Running Database Migrations

Migrations cannot be performed within the docker container as the server, client and api folders are mounted as read only to prevent messed up permissions.
You must run migrations outside of the django container over the network with the database running.
To start the database, navigate to `docker/` and run: `docker compose up database`.
Then, source the install script by navigating to the git repository root directory and running: `. scripts/install.sh`.

You can then use the `manage ...` script family in the same way you use the `python3 manage.py ...` script family.

### Migration Example
```
$ (env) manage makemigrations && manage migrate
  > No changes detected
  > Operations to perform:
  >   Apply all migrations: admin, api, auth, contenttypes, sessions
  > Running migrations:
  >   No migrations to apply.
```

### SQL Migrate Example

```
$ (env) manage sqlmigrate api 0001
  > BEGIN;
  > --
  > -- Create model Post
  > --
  > CREATE TABLE "api_post" ("id" bigint NOT NULL PRIMARY KEY GENERATED BY ... etc
  > COMMIT;
```
